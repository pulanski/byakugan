permissions:
    contents: read
on:
    push:
        branches: [main]
    pull_request:
# Spend CI time only on latest ref: https://github.com/jonhoo/rust-ci-conf/pull/5
concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true
name: check
jobs:
    clippy:
        runs-on: ubuntu-latest
        name: ${{ matrix.toolchain }} / clippy
        permissions:
            contents: read
            checks: write
        strategy:
            fail-fast: false
            matrix:
                toolchain: [stable, beta]
        steps:
            - uses: actions/checkout@v3
              with:
                  submodules: true
            - name: Install ${{ matrix.toolchain }}
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: ${{ matrix.toolchain }}
                  components: clippy
            - name: cargo clippy
              uses: actions-rs/clippy-check@v1
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
    doc:
        runs-on: ubuntu-latest
        name: nightly / doc
        steps:
            - uses: actions/checkout@v3
              with:
                  submodules: true
            - name: Install nightly
              uses: dtolnay/rust-toolchain@nightly
            - name: cargo doc
              run: cargo doc --no-deps --all-features
              env:
                  RUSTDOCFLAGS: --cfg docsrs
    hack:
        runs-on: ubuntu-latest
        name: ubuntu / stable / features
        steps:
            - uses: actions/checkout@v3
              with:
                  submodules: true
            - name: Install stable
              uses: dtolnay/rust-toolchain@stable
            - name: cargo install cargo-hack
              uses: taiki-e/install-action@cargo-hack
            # intentionally no target specifier; see https://github.com/jonhoo/rust-ci-conf/pull/4
            - name: cargo hack
              run: cargo hack --feature-powerset check
